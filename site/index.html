<!DOCTYPE html>
<html lang="en">
<head>
  
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link  rel="stylesheet" type="text/css" href="home.css">  <!-- ! ดึงไฟล์css -->
   
    <title>Document</title>
   
</head>
<body>
    
<div class="topnav">
    <a>VbixLib</a>
   
    <div class="search-container">
      <form action="/action_page.php">
        <input type="text" id="myInput" onkeyup="myFunction()" placeholder="Search for names.." title="Type in a name">
       
      </form>
    </div>
  </div>
  
  <div style="padding-left:16px">
    <h2>VbixLib</h2>
    <h3>description</h3>
</div>

  
<div class="sidenav">
  <ul id="myUL">

    <!--! ******************************************************************-->
  <button class="dropdown-btn"><h4>SCG ICO</h4></button> 
    <div class="dropdown-container">
        
  <button class="dropdown-btn" style="background-color: rgb(237, 236, 236);"><h4>HR Employee Request Letter</h4></button> 
  <div class="dropdown-container ">
    
  <button class="dropdown-btn" style="background-color: rgb(252, 252, 252);"><h4>HR Letter: Guarantee Letter  - Create HR Letter</h4></button> 
  <div class="dropdown-container">
    
    <pre>
      <code>
        //credentials
        var domain = "scgico.kissflow.com";
        var accountId = "Ac1xXSibOUGjQ";
        var processId = "SCG_ICO_HR_Letter_Request";
        var apiKey = "Ake499efdd-1000-4efd-aa26-569bddf717d4"; // Kissflow VBix API Key //
        var instanceId = "Pkw5K_nuHE6aT";
        //document and folder ids/ urls
        const TEMPLATE_ID = "15CUGYC0kS4zdf3A5KLWj1PF2XL-T4r6q-nJ7x3vLQg8";
        const BACKUP_FOLDER_ID = "1TKB1iV98Q8mw4tQLZJgNdbhfNoIwhIZQ";
        const IMAGE_TYPE = [".png", ".jpg"];
        const LOG_URL = "https://docs.google.com/document/d/1YQ4P8goZJT9QUKiitKhDaoazDowJKIbxK8cbyoARqfE/edit";
        
        
        //stand alone function to test the script
        function standAlone() {
          try {
            var jsonData = VBixLib.getUpdateData(domain, accountId, apiKey, processId, instanceId);
            Logger.log(jsonData)
            var jsonString = JSON.stringify(jsonData)
            var blob = Utilities.newBlob(jsonString);
            var e = {
              postData: blob
            };
            doPost(e);
        
          } catch (err) {
            setLog(">> "+new Date() + " : " + err.stack);
          }
        }
        
        
        function doPost(e) {
          try {
            var jsonString = e.postData.getDataAsString();
            var jsonData = JSON.parse(jsonString);
            var refNo = jsonData["Ref_No"] || "";
            var subject = jsonData["Subject"] || "";
            var instanceId = jsonData["_id"] || "";
            var managerEmail = jsonData["Manager_Email"] || "";
            // Utilities.sleep(15000)
            jsonData = VBixLib.getUpdateData(domain, accountId, apiKey, processId, instanceId);
            var hrletter = jsonData["HRLetter"] || "";
            setLog(">> "+new Date() + " : " + "Create new "  + hrletter + " of request no. " + refNo);
            // var memoType = jsonData["Memo_Type"] || "";
            // var templateId = TEMPLATES_IDS[memoType];
            var template = DriveApp.getFileById(TEMPLATE_ID);
            var fileName = hrletter + " " + refNo;
            var newTemplate = template.makeCopy().setName(fileName);
            var newTemplateFile = DocumentApp.openByUrl(newTemplate.getUrl());
            var body = newTemplateFile.getBody();
            var footer = newTemplateFile.getFooter();
            var hasTable = false;
        
            //write data to sheet main
            for (var fieldId in jsonData) {
              var field = jsonData[fieldId] || 0;
              var searchPattern = "{" + fieldId + "}";
              //console.log(searchPattern);
              if (typeof(field["key"]) !== "undefined") {
        
                //detect for signature
                var signatureImage = VBixLib.getSignatureOverGrid(domain, accountId, apiKey, processId, instanceId, field["key"]);
                  var found = replaceTextToImage(body, searchPattern, signatureImage, 150);
                  found = replaceTextToImage(footer, searchPattern, signatureImage, 150);   
        
              } else {
                body.replaceText(searchPattern, field);
                footer.replaceText(searchPattern, field);
              }
        
            }
            // newTemplateFile.saveAndClose();
            //replace field inside footer
             footer.replaceText('{(.*?)}', '');
             body.replaceText('{(.*?)}', '');
             
         
            newTemplateFile.saveAndClose();
            //backup all sheet
             var backupFolder = DriveApp.getFolderById(BACKUP_FOLDER_ID);
             var copiedFile = DriveApp.getFileById(newTemplate.getId()).makeCopy().setName(newTemplate.getName() + "-Document")
             copiedFile.moveTo(backupFolder);
        
            // backup pdf 
            // var docx = VBixLib.exportFile(newTemplate.getId(), "docx", newTemplate.getName());
            // backupFolder.createFile(docx);
        
            var pdf = VBixLib.exportFile(newTemplate.getId(), "pdf", newTemplate.getName());
            backupFolder.createFile(pdf);
           
             var status = jsonData["_status"] || "";
             if(status=="InProgress"){
            VBixLib.uploadWithDelete(domain,accountId,apiKey,processId,instanceId,"Draft_Letter",pdf,true);
            }
        
            // remove new template file
            var removeFile = DriveApp.getFileById(newTemplate.getId());
            removeFile.setTrashed(true);
            // removeFile = DriveApp.getFileById(tableTemplate.getId());
            // removeFile.setTrashed(true);
        
            Logger.log(status)
            if(status=="Completed"){
        //send email
            var subject = "Your HR Letter Guarantee Letter Was Approved";
            var mailBody = "FYI: Your HR Letter Guarantee Letter  was approved, please check the attached file.";
            var mail = jsonData["Requester_Email"] || "";
            GmailApp.sendEmail(mail, subject, mailBody, {bcc: "fauzanoi@scg.com, elcidita@scg.com, argarizk@scg.com,chidsanucha.n@vbix.co.th," + managerEmail, attachments: pdf});
             VBixLib.uploadWithDelete(domain,accountId,apiKey,processId,instanceId,"Approved_Letter",pdf,true);
            }
        
        
            setLog("New " + hrletter + " HR Letter created.");
          } catch (err) {
            setLog(err.stack);
            throw err;
          }
        }
        
        // //script from https://gist.github.com/tanaikech/f84831455dea5c394e48caaee0058b26
        function replaceTextToImage(body, searchText, image, width) {
          var next = body.findText(searchText);
          if (!next) return;
          var r = next.getElement();
          r.asText().setText("");
          var img = r.getParent().asParagraph().insertInlineImage(0, image);
          if (width && typeof width == "number") {
            var w = img.getWidth();
            var h = img.getHeight();
            img.setWidth(width);
            img.setHeight(width * h / w);
          }
          return next;
        };
        
        function setLog(message) {
          var doc = DocumentApp.openByUrl(LOG_URL)
          var body = doc.getBody();
          body.appendParagraph(message);
        }
      </code>
  </pre>
    
    
  </div>
  <button class="dropdown-btn" style="background-color: rgb(252, 252, 252);"><h4>HR Letter: Create Company Certificated Letter</h4></button> 
  <div class="dropdown-container">
    
    <pre>
      <code>
        //credentials
var domain = "scgico.kissflow.com";
var accountId = "Ac1xXSibOUGjQ";
var processId = "SCG_ICO_HR_Letter_Request";
var apiKey = "Ake499efdd-1000-4efd-aa26-569bddf717d4"; // Kissflow VBix API Key //
var instanceId = "PknWyWSxIz6xa";
//document and folder ids/ urls
const TEMPLATE_ID = "1ZOLBrEmIS1dHlo0wrO9nM-XVQWrOM_mThDW_LBIpdEE";
const BACKUP_FOLDER_ID = "1TKB1iV98Q8mw4tQLZJgNdbhfNoIwhIZQ";
const IMAGE_TYPE = [".png", ".jpg"];
const LOG_URL = "https://docs.google.com/document/d/1r_7G5_MEQyfx4Agtg0UciIXAhALCDMOFL5eAzhuNInQ/edit";


//stand alone function to test the script
function standAlone() {
  try {
    var jsonData = VBixLib.getUpdateData(domain, accountId, apiKey, processId, instanceId);
    var jsonString = JSON.stringify(jsonData)
    var blob = Utilities.newBlob(jsonString);
    var e = {
      postData: blob
    };
    doPost(e);

  } catch (err) {
    setLog(">> "+new Date() + " : " + err.stack);
  }
}


 
function doPost(e) {
  try {
    var jsonString = e.postData.getDataAsString();
    var jsonData = JSON.parse(jsonString);
    var refNo = jsonData["Ref_No"] || "";
    var instanceId = jsonData["_id"] || "";

    var shownik = jsonData["Show_Citizen_ID"] || "";
    var showsalary = jsonData["Show_Salary"] || "";
    var showallowance= jsonData["Show_Fixed_Allowance"] || "";
    var showaddress = jsonData["Show_Address"] || "";
    var transportationallowance = jsonData["Transportation_Allowance"] || "";
    var carallowance = jsonData["Car_Allowance_in_IDR"] || "";
    var marriageallowance = jsonData["Marriage_Allowance"] || "";
    var gasolineallowance = jsonData["Gasoline_Allowance"] || "";
    var communicationalowance = jsonData["Communication_Allowance"] || "";
    var totalsalaryandallowance = jsonData["Total_Salary_and_Allowance"] || "";
    // Utilities.sleep(10000)
    jsonData = VBixLib.getUpdateData(domain, accountId, apiKey, processId, instanceId);
    console.log(jsonData);
    var hrletter = jsonData["HRLetter"] || ""; 
    console.log(hrletter);
    var template = DriveApp.getFileById(TEMPLATE_ID);
    var fileName = hrletter + " " + refNo;
    var newTemplate = template.makeCopy().setName(fileName);
    var newTemplateFile = DocumentApp.openByUrl(newTemplate.getUrl());
    var body = newTemplateFile.getBody();
    var footer = newTemplateFile.getFooter();
     setLog(">> "+new Date() + " : " + "Create new "  + fileName + " of request no. " + refNo);


    if(shownik==true){
    body.replaceText("{NIK}", "\nNIK: 				");
    }else{
      body.replaceText("{NIK}", "");
    }

    if(showsalary==true){
    body.replaceText("{Salary:}", "\nSalary per Month: 		");
    }else{
      body.replaceText("{Salary:}", "");
    }

    if(showallowance==true){
    body.replaceText("{FixedAllowance}", "\nAllowance per Month: 	");
    if(transportationallowance==""){body.replaceText("{TransportationAllowance}", "");}
    else{
    body.replaceText("{TransportationAllowance}", "Meal and Transport: IDR ");
    }
    if(carallowance==""){body.replaceText("{CarAllowance}", "");}
    else{
    body.replaceText("{CarAllowance}", "\n				Car: IDR ");
    }
    if(marriageallowance==""){body.replaceText("{MarriageAllowance}", "");}
    else{
    body.replaceText("{MarriageAllowance}", "\n				Marriage: IDR ");
    }
    if(gasolineallowance==""){body.replaceText("{GasolineAllowance}", "");}
    else{
    body.replaceText("{GasolineAllowance}", "\n				Gasoline: IDR ");
    }
    if(communicationalowance==""){body.replaceText("{CommunicationAllowance}","");}
    else{
    body.replaceText("{CommunicationAllowance}", "\n				Communication: IDR ");
    }
    }else{
    body.replaceText("{FixedAllowance}", "");
    }
     if(totalsalaryandallowance==""){body.replaceText("{TotalSalaryandAllowance}","");}
    else{
    body.replaceText("{TotalSalaryandAllowance}", "\nTotal Salary and \nAllowance per Month:            ");
    }
    if(showaddress==true){
    body.replaceText("{Address}", '\nAddress: 			');
    body.replaceText("{Street/Number}", 'Street/Number:');
    body.replaceText("{City/Regency}", '\n				City/Regency:');
    body.replaceText("{Province:}", '\n				Province:');
    body.replaceText("{ZipCode}", '\n				Zip Code:');
    }else{
      
    body.replaceText("{Address}", '');
    body.replaceText("{Street/Number}", '');
    body.replaceText("{City/Regency}", '');
    body.replaceText("{Province:}", '');
    body.replaceText("{ZipCode}", '');
    }
  
    //write data to sheet main
    for (var fieldId in jsonData) {
      var field = jsonData[fieldId] || 0;
      var searchPattern = "{" + fieldId + "}";
     
      if (typeof(field["key"]) !== "undefined") {
        //detect for signature
 
          var signatureImage = VBixLib.getSignatureOverGrid(domain, accountId, apiKey, processId, instanceId, field["key"]);
          var found = replaceTextToImage(body, searchPattern, signatureImage, 150);
          found = replaceTextToImage(footer, searchPattern, signatureImage, 150);        
          
      } 
      else {
        body.replaceText(searchPattern, field);
        footer.replaceText(searchPattern, field);
      }

    }
  
    //replace field inside footer
    footer.replaceText('{(.*?)}', '');
    body.replaceText('{(.*?)}', '');
     
 
    newTemplateFile.saveAndClose();
    //backup all sheet
    var backupFolder = DriveApp.getFolderById(BACKUP_FOLDER_ID);
    var copiedFile = DriveApp.getFileById(newTemplate.getId()).makeCopy().setName(newTemplate.getName() + "-Document")
    copiedFile.moveTo(backupFolder);

    // backup pdf 
    // var docx = VBixLib.exportFile(newTemplate.getId(), "docx", newTemplate.getName());
    // backupFolder.createFile(docx);

    var pdf = VBixLib.exportFile(newTemplate.getId(), "pdf", newTemplate.getName());
    backupFolder.createFile(pdf);
    
    var status = jsonData["_status"] || "";
    if(status=="InProgress"){
    VBixLib.uploadWithDelete(domain,accountId,apiKey,processId,instanceId,"Draft_Letter",pdf,true);
    }
    Logger.log(status)
    if(status=="Completed"){
    //send email
     var subject = "Your HR Letter Company Certificated Letter Was Approved";
     var mailBody = "FYI: Your HR Letter Company Certificated Letter was approved, please check the attached file.";
    // //upload file to Kissflow
     var mail = jsonData["Requester_Email"] || "";
    GmailApp.sendEmail(mail, subject, mailBody, { attachments: pdf , bcc: "fauzanoi@scg.com, elcidita@scg.com, argarizk@scg.com,chidsanucha.n@vbix.co.th"});
    VBixLib.uploadWithDelete(domain,accountId,apiKey,processId,instanceId,"Approved_Letter",pdf,true);
    }
   
    // remove new template file
    var removeFile = DriveApp.getFileById(newTemplate.getId());
    removeFile.setTrashed(true);


    setLog("New HR Letter" + fileName + "created.");
  } catch (err) {
    setLog(err.stack);
    throw err;
  }
}

 //script from https://gist.github.com/tanaikech/f84831455dea5c394e48caaee0058b26
function replaceTextToImage(body, searchText, image, width) {
  var next = body.findText(searchText);
  if (!next) return;
  var r = next.getElement();
  r.asText().setText("");
  var img = r.getParent().asParagraph().insertInlineImage(0, image);
  if (width && typeof width == "number") {
    var w = img.getWidth();
    var h = img.getHeight();
    img.setWidth(width);
    img.setHeight(width * h / w);
  }
  return next;
};

function setLog(message) {
  var doc = DocumentApp.openByUrl(LOG_URL)
  var body = doc.getBody();
  body.appendParagraph(message);
}
      </code>
  </pre>
    
    
  </div>


  </div>
  
  
    </div>
    

 <!--! ******************************************************************-->

    <button class="dropdown-btn"><h4>bsdagwe</h4>
        
      </button>
      <div class="dropdown-container">
        <pre>
          <code>
              &lt;!doctype html&gt;
              &lt;html lang="en-US"&gt;
              &lt;head&gt;
                  &lt;meta charset="utf-8"&gt;                
                  &lt;meta name="generator" content="JSFiddle"&gt;
                  &lt;/body&gt;
                  &lt;meta name="description" content="Displaying your source code on web page."&gt;
                  &lt;meta name="author" content="Anna Medvedeva"&gt;
              &lt;/head&gt;
              &lt;body&gt;
                  &lt;h1&gt;Displaying your source code on web page&lt;/h1&gt;
                  &lt;p1&gt;Do you read, write and speak code? Learn how to share your skills!&lt;/p&gt;
              &lt;/body&gt;
              &lt;/html&gt;
          </code>
      </pre>
       
      </div>
      <button class="dropdown-btn"><h4>csatd5w</h4>
        
      </button>
      <div class="dropdown-container">
        <pre>
          <code>
              &lt;!doctype html&gt;
              &lt;html lang="en-US"&gt;
              &lt;head&gt;
                  &lt;meta charset="utf-8"&gt;                
                  &lt;meta name="generator" content="JSFiddle"&gt;
                  &lt;/body&gt;
                  &lt;meta name="description" content="Displaying your source code on web page."&gt;
                  &lt;meta name="author" content="Anna Medvedeva"&gt;
              &lt;/head&gt;
              &lt;body&gt;
                  &lt;h1&gt;Displaying your source code on web page&lt;/h1&gt;
                  &lt;p1&gt;Do you read, write and speak code? Learn how to share your skills!&lt;/p&gt;
              &lt;/body&gt;
              &lt;/html&gt;
          </code>
      </pre>
       
      </div>
      <button class="dropdown-btn"><h4>dsfhgt</h4>
        
      </button>
      <div class="dropdown-container">
        <pre>
          <code>
              &lt;!doctype html&gt;
              &lt;html lang="en-US"&gt;
              &lt;head&gt;
                  &lt;meta charset="utf-8"&gt;                
                  &lt;meta name="generator" content="JSFiddle"&gt;
                  &lt;/body&gt;
                  &lt;meta name="description" content="Displaying your source code on web page."&gt;
                  &lt;meta name="author" content="Anna Medvedeva"&gt;
              &lt;/head&gt;
              &lt;body&gt;
                  &lt;h1&gt;Displaying your source code on web page&lt;/h1&gt;
                  &lt;p1&gt;Do you read, write and speak code? Learn how to share your skills!&lt;/p&gt;
              &lt;/body&gt;
              &lt;/html&gt;
          </code>
      </pre>

       
      </div>
      

   </ul>
  </div>
  <script src="home.js">
  </script>
  
</body>
</html>