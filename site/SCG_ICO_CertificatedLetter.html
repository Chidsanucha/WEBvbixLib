<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link  rel="stylesheet" type="text/css" href="index.css">  <!-- ! ดึงไฟล์css -->
</head>
<body>
  <pre>
    <code>
      //credentials
      var domain = "scgico.kissflow.com";
      var accountId = "Ac1xXSibOUGjQ";
      var processId = "SCG_ICO_HR_Letter_Request";
      var apiKey = "Ake499efdd-1000-4efd-aa26-569bddf717d4"; // Kissflow VBix API Key //
      var instanceId = "PknWyWSxIz6xa";
      //document and folder ids/ urls
      const TEMPLATE_ID = "1ZOLBrEmIS1dHlo0wrO9nM-XVQWrOM_mThDW_LBIpdEE";
      const BACKUP_FOLDER_ID = "1TKB1iV98Q8mw4tQLZJgNdbhfNoIwhIZQ";
      const IMAGE_TYPE = [".png", ".jpg"];
      const LOG_URL = "https://docs.google.com/document/d/1r_7G5_MEQyfx4Agtg0UciIXAhALCDMOFL5eAzhuNInQ/edit";
      
      
      //stand alone function to test the script
      function standAlone() {
        try {
          var jsonData = VBixLib.getUpdateData(domain, accountId, apiKey, processId, instanceId);
          var jsonString = JSON.stringify(jsonData)
          var blob = Utilities.newBlob(jsonString);
          var e = {
            postData: blob
          };
          doPost(e);
      
        } catch (err) {
          setLog(">> "+new Date() + " : " + err.stack);
        }
      }
      
      
       
      function doPost(e) {
        try {
          var jsonString = e.postData.getDataAsString();
          var jsonData = JSON.parse(jsonString);
          var refNo = jsonData["Ref_No"] || "";
          var instanceId = jsonData["_id"] || "";
      
          var shownik = jsonData["Show_Citizen_ID"] || "";
          var showsalary = jsonData["Show_Salary"] || "";
          var showallowance= jsonData["Show_Fixed_Allowance"] || "";
          var showaddress = jsonData["Show_Address"] || "";
          var transportationallowance = jsonData["Transportation_Allowance"] || "";
          var carallowance = jsonData["Car_Allowance_in_IDR"] || "";
          var marriageallowance = jsonData["Marriage_Allowance"] || "";
          var gasolineallowance = jsonData["Gasoline_Allowance"] || "";
          var communicationalowance = jsonData["Communication_Allowance"] || "";
          var totalsalaryandallowance = jsonData["Total_Salary_and_Allowance"] || "";
          // Utilities.sleep(10000)
          jsonData = VBixLib.getUpdateData(domain, accountId, apiKey, processId, instanceId);
          console.log(jsonData);
          var hrletter = jsonData["HRLetter"] || ""; 
          console.log(hrletter);
          var template = DriveApp.getFileById(TEMPLATE_ID);
          var fileName = hrletter + " " + refNo;
          var newTemplate = template.makeCopy().setName(fileName);
          var newTemplateFile = DocumentApp.openByUrl(newTemplate.getUrl());
          var body = newTemplateFile.getBody();
          var footer = newTemplateFile.getFooter();
           setLog(">> "+new Date() + " : " + "Create new "  + fileName + " of request no. " + refNo);
      
      
          if(shownik==true){
          body.replaceText("{NIK}", "\nNIK: 				");
          }else{
            body.replaceText("{NIK}", "");
          }
      
          if(showsalary==true){
          body.replaceText("{Salary:}", "\nSalary per Month: 		");
          }else{
            body.replaceText("{Salary:}", "");
          }
      
          if(showallowance==true){
          body.replaceText("{FixedAllowance}", "\nAllowance per Month: 	");
          if(transportationallowance==""){body.replaceText("{TransportationAllowance}", "");}
          else{
          body.replaceText("{TransportationAllowance}", "Meal and Transport: IDR ");
          }
          if(carallowance==""){body.replaceText("{CarAllowance}", "");}
          else{
          body.replaceText("{CarAllowance}", "\n				Car: IDR ");
          }
          if(marriageallowance==""){body.replaceText("{MarriageAllowance}", "");}
          else{
          body.replaceText("{MarriageAllowance}", "\n				Marriage: IDR ");
          }
          if(gasolineallowance==""){body.replaceText("{GasolineAllowance}", "");}
          else{
          body.replaceText("{GasolineAllowance}", "\n				Gasoline: IDR ");
          }
          if(communicationalowance==""){body.replaceText("{CommunicationAllowance}","");}
          else{
          body.replaceText("{CommunicationAllowance}", "\n				Communication: IDR ");
          }
          }else{
          body.replaceText("{FixedAllowance}", "");
          }
           if(totalsalaryandallowance==""){body.replaceText("{TotalSalaryandAllowance}","");}
          else{
          body.replaceText("{TotalSalaryandAllowance}", "\nTotal Salary and \nAllowance per Month:            ");
          }
          if(showaddress==true){
          body.replaceText("{Address}", '\nAddress: 			');
          body.replaceText("{Street/Number}", 'Street/Number:');
          body.replaceText("{City/Regency}", '\n				City/Regency:');
          body.replaceText("{Province:}", '\n				Province:');
          body.replaceText("{ZipCode}", '\n				Zip Code:');
          }else{
            
          body.replaceText("{Address}", '');
          body.replaceText("{Street/Number}", '');
          body.replaceText("{City/Regency}", '');
          body.replaceText("{Province:}", '');
          body.replaceText("{ZipCode}", '');
          }
        
          //write data to sheet main
          for (var fieldId in jsonData) {
            var field = jsonData[fieldId] || 0;
            var searchPattern = "{" + fieldId + "}";
           
            if (typeof(field["key"]) !== "undefined") {
              //detect for signature
       
                var signatureImage = VBixLib.getSignatureOverGrid(domain, accountId, apiKey, processId, instanceId, field["key"]);
                var found = replaceTextToImage(body, searchPattern, signatureImage, 150);
                found = replaceTextToImage(footer, searchPattern, signatureImage, 150);        
                
            } 
            else {
              body.replaceText(searchPattern, field);
              footer.replaceText(searchPattern, field);
            }
      
          }
        
          //replace field inside footer
          footer.replaceText('{(.*?)}', '');
          body.replaceText('{(.*?)}', '');
           
       
          newTemplateFile.saveAndClose();
          //backup all sheet
          var backupFolder = DriveApp.getFolderById(BACKUP_FOLDER_ID);
          var copiedFile = DriveApp.getFileById(newTemplate.getId()).makeCopy().setName(newTemplate.getName() + "-Document")
          copiedFile.moveTo(backupFolder);
      
          // backup pdf 
          // var docx = VBixLib.exportFile(newTemplate.getId(), "docx", newTemplate.getName());
          // backupFolder.createFile(docx);
      
          var pdf = VBixLib.exportFile(newTemplate.getId(), "pdf", newTemplate.getName());
          backupFolder.createFile(pdf);
          
          var status = jsonData["_status"] || "";
          if(status=="InProgress"){
          VBixLib.uploadWithDelete(domain,accountId,apiKey,processId,instanceId,"Draft_Letter",pdf,true);
          }
          Logger.log(status)
          if(status=="Completed"){
          //send email
           var subject = "Your HR Letter Company Certificated Letter Was Approved";
           var mailBody = "FYI: Your HR Letter Company Certificated Letter was approved, please check the attached file.";
          // //upload file to Kissflow
           var mail = jsonData["Requester_Email"] || "";
          GmailApp.sendEmail(mail, subject, mailBody, { attachments: pdf , bcc: "fauzanoi@scg.com, elcidita@scg.com, argarizk@scg.com,chidsanucha.n@vbix.co.th"});
          VBixLib.uploadWithDelete(domain,accountId,apiKey,processId,instanceId,"Approved_Letter",pdf,true);
          }
         
          // remove new template file
          var removeFile = DriveApp.getFileById(newTemplate.getId());
          removeFile.setTrashed(true);
      
      
          setLog("New HR Letter" + fileName + "created.");
        } catch (err) {
          setLog(err.stack);
          throw err;
        }
      }
      
       //script from https://gist.github.com/tanaikech/f84831455dea5c394e48caaee0058b26
      function replaceTextToImage(body, searchText, image, width) {
        var next = body.findText(searchText);
        if (!next) return;
        var r = next.getElement();
        r.asText().setText("");
        var img = r.getParent().asParagraph().insertInlineImage(0, image);
        if (width && typeof width == "number") {
          var w = img.getWidth();
          var h = img.getHeight();
          img.setWidth(width);
          img.setHeight(width * h / w);
        }
        return next;
      };
      
      function setLog(message) {
        var doc = DocumentApp.openByUrl(LOG_URL)
        var body = doc.getBody();
        body.appendParagraph(message);
      }
    </code>
  </pre>
</body>
</html>